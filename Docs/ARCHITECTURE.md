# ๐ Flujo de Datos y Arquitectura

## Flujo Principal de Ejecuciรณn

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                      INICIO: Cron Job / HTTP Request                    โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    main.py (Servidor HTTP)                              โ
โ  โข Inicializa todas las dependencias                                    โ
โ  โข Crea instancias de clientes, repositorio, servicio                  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    Router (routes/routes.py)                            โ
โ  โข GET /api/v1/trigger-fetch                                            โ
โ  โข Enruta la peticiรณn al handler correspondiente                       โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                  PriceHandler (handlers/handler.py)                     โ
โ  โข Recibe la peticiรณn HTTP                                              โ
โ  โข Extrae parรกmetros (ej: hour=10)                                     โ
โ  โข Delega al servicio                                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                                 โ
                                 โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ             PriceDataService (services/service.py)                      โ
โ  LรGICA DE NEGOCIO PRINCIPAL                                            โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ 1. Determinar hora objetivo (10:00 o 17:00 ART)                  โ โ
โ  โ 2. Calcular timestamps UTC (ยฑ10 minutos)                         โ โ
โ  โ 3. Obtener precios de Bitcoin y Oro (en paralelo lรณgico)         โ โ
โ  โ 4. Normalizar y validar datos                                    โ โ
โ  โ 5. Guardar en MongoDB                                            โ โ
โ  โ 6. Enviar a Google Sheets                                        โ โ
โ  โ 7. Retornar resultado                                            โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโ
     โ                                                         โ
     โ                                                         โ
     โผ                                                         โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ BITCOIN FLOW                        โ  โ GOLD FLOW                    โ
โ                                     โ  โ                              โ
โ 1. CoinGeckoClient                  โ  โ 1. MetalsApiClient          โ
โ    โโ> get_bitcoin_price_in_range() โ  โ    โโ> get_gold_closing()   โ
โ                                     โ  โ                              โ
โ 2. time_utils                       โ  โ 2. Cรกlculo crรญtico:         โ
โ    โโ> find_closest_price()         โ  โ    price = 1 / xau_usd      โ
โ                                     โ  โ                              โ
โ 3. AssetPriceRecord                 โ  โ 3. AssetPriceRecord         โ
โ    โโ> asset_name: "BTC"            โ  โ    โโ> asset_name: "XAU"    โ
โ    โโ> price_usd: $XX,XXX           โ  โ    โโ> price_usd: $X,XXX    โ
โ    โโ> source_api: "coingecko"      โ  โ    โโ> source_api: "metals" โ
โโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโ
              โ                                      โ
              โโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ   PERSISTENCIA (en paralelo)               โ
            โ                                            โ
            โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
            โ  โ PriceRepository                      โ โ
            โ  โ  โโ> save_price_record()             โ โ
            โ  โ      โโ> MongoDB: btc_oro_db         โ โ
            โ  โ          โโ> Collection: asset_pricesโ โ
            โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
            โ                                            โ
            โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
            โ  โ GoogleSheetClient                    โ โ
            โ  โ  โโ> save_record()                   โ โ
            โ  โ      โโ> Google Sheets API           โ โ
            โ  โ          โโ> Append to spreadsheet   โ โ
            โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ โ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ   ServiceResponse                          โ
            โ   {                                        โ
            โ     success: true,                         โ
            โ     message: "...",                        โ
            โ     records_processed: 2,                  โ
            โ     errors: []                             โ
            โ   }                                        โ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                             โ
                             โผ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
            โ   HTTP Response (JSON)                     โ
            โ   Status: 200 OK                           โ
            โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Arquitectura de Capas (Cebolla)

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     CAPA DE PRESENTACIรN                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  main.py (Servidor HTTP)                               โ  โ
โ  โ  โข http.server.HTTPServer                              โ  โ
โ  โ  โข RequestHandler                                      โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     CAPA DE ENRUTAMIENTO                     โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  routes/routes.py                                      โ  โ
โ  โ  โข Router                                              โ  โ
โ  โ  โข Mapeo de URLs a handlers                           โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     CAPA DE HANDLERS                         โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  handlers/handler.py                                   โ  โ
โ  โ  โข PriceHandler                                        โ  โ
โ  โ  โข Procesamiento de peticiones                        โ  โ
โ  โ  โข NO contiene lรณgica de negocio                      โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                               โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                     CAPA DE SERVICIOS                        โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โ  โ  services/service.py                                   โ  โ
โ  โ  โข PriceDataService                                    โ  โ
โ  โ  โข Orquestaciรณn de lรณgica de negocio                  โ  โ
โ  โ  โข Coordina clientes y repositorio                    โ  โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโฌโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                               โ
                โโโโโโโโโโโโโโโโดโโโโโโโโโโโโโโโ
                โ                             โ
โโโโโโโโโโโโโโโโโผโโโโโโโโโโโโโโโ  โโโโโโโโโโโโผโโโโโโโโโโโโโโโโโ
โ    CAPA DE CLIENTES          โ  โ  CAPA DE REPOSITORIO      โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโ โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโ โ
โ  โ clients/api_clients.py  โ โ  โ  โ repositories/        โ โ
โ  โ โข CoinGeckoClient       โ โ  โ  โ   repository.py      โ โ
โ  โ โข MetalsApiClient       โ โ  โ  โ โข PriceRepository    โ โ
โ  โ โข GoogleSheetClient     โ โ  โ  โ โข Acceso a MongoDB   โ โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโ โ  โ  โโโโโโโโโโโโโโโโโโโโโโโโ โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                โ                             โ
                โผ                             โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                   CAPA DE DATOS EXTERNOS                     โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ   โ
โ  โ  CoinGecko   โ  โ  Metals-API  โ  โ  Google Sheets   โ   โ
โ  โ     API      โ  โ     API      โ  โ      API         โ   โ
โ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโ  โโโโโโโโโโโโโโโโโโโโ   โ
โ                                                              โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โ  โ               MongoDB Database                       โ   โ
โ  โ  Database: btc_oro_db                                โ   โ
โ  โ  Collection: asset_prices                            โ   โ
โ  โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Capas Transversales

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    MODELOS DE DATOS                          โ
โ  models/schemas.py (Pydantic)                                โ
โ  โข CoinGeckoResponse      โข AssetPriceRecord                 โ
โ  โข MetalsApiResponse      โข GoogleSheetRecord                โ
โ  โข ServiceResponse                                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                       UTILIDADES                             โ
โ  utils/time_utils.py                                         โ
โ  โข Conversiรณn ART โ UTC                                      โ
โ  โข Cรกlculo de timestamps                                     โ
โ  โข Bรบsqueda de precio mรกs cercano                           โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ                    CONFIGURACIรN                             โ
โ  config.py + .env                                            โ
โ  โข Variables de entorno                                      โ
โ  โข Constantes del proyecto                                   โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Manejo de Zona Horaria

```
ENTRADA (Cron/User)          PROCESAMIENTO              SALIDA
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ

10:00 ART                                               MongoDB:
  โ                                                     timestamp_utc
  โ                    โโโโโโโโโโโโโโโโโโโโโ
  โผ                    โ   time_utils      โ
10:00 ART โโโโโโโโโ> โ                   โ โโโโโโโ> 13:00 UTC
                       โ  ART = UTC - 3   โ
                       โ                   โ          Google Sheets:
                       โ  10:00 - (-3)    โ          collection_time_art
                       โ  = 13:00 UTC     โ โโโโโโโ> 10:00 ART
                       โโโโโโโโโโโโโโโโโโโโโ

โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  CoinGecko API requiere timestamps en UTC (Unix seconds)   โ
โ  from: 12:50 UTC  to: 13:10 UTC  (ยฑ10 minutos)             โ
โ                                                             โ
โ  Se busca el precio mรกs cercano a 13:00 UTC                โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Estructura de Datos en MongoDB

```javascript
{
  "_id": ObjectId("..."),
  "asset_name": "BTC",              // o "XAU"
  "price_usd": 43250.75,            // Precio en USD
  "timestamp_utc": ISODate("2025-10-24T13:00:00Z"),
  "source_api": "coingecko",        // o "metals-api"
  "collection_time_art": ISODate("2025-10-24T10:00:00-03:00"),
  "target_hour_art": 10             // 10 o 17
}
```

## Flujo de Errores

```
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Cada capa maneja sus propios errores y los propaga        โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                               โ
                               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  Clients:  RequestException โ Logged + Re-raised            โ
โ  Service:  Captura errores โ Agrega a lista de errores     โ
โ  Handler:  Convierte a respuesta HTTP con cรณdigo apropiado โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
                               โ
                               โผ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
โ  ServiceResponse:                                           โ
โ  {                                                          โ
โ    success: false,                                          โ
โ    records_processed: 1,  // BTC OK, Oro fallรณ             โ
โ    errors: ["No se pudo obtener el precio del Oro"]        โ
โ  }                                                          โ
โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ
```

## Inyecciรณn de Dependencias

```
main.py inicializa todo:

1. Config.validate_config()
2. CoinGeckoClient(api_key)      โโโ
3. MetalsApiClient(api_key)      โโโค
4. GoogleSheetClient(url)        โโโผโโ> PriceDataService()
5. PriceRepository(uri, db)      โโโ           โ
                                               โผ
                                       PriceHandler()
                                               โ
                                               โผ
                                           Router()
```

## Cรกlculo Crรญtico: Precio del Oro

```
API Metals-API devuelve:
{
  "rates": {
    "XAUUSD": 0.000515  // 1 USD = 0.000515 onzas de oro
  }
}

Cรกlculo correcto:
precio_por_onza = 1 / 0.000515 = $1,941.75 USD/onza

โ ERROR COMรN: Usar directamente el valor 0.000515
โ CORRECTO: Calcular 1 / valor_recibido
```